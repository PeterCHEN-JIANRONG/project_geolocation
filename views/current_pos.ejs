<!DOCTYPE html>
<html>
  <head>
    <title>Get your position</title>
    <style>
      #map {
        height: 100%;
      }
      html,body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
    </style>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  </head>
  <body>
    <!-- <button id="show">Show my location</button> -->
    <div id="map"></div>
    <p><%= lat %></p>
    <p><%= lng %></p>
    <script>
      var pos;
      var map;
      var x1 = 24.9793,y1 = 121.55232,x2 = 24.977,y2 = 121.54865;
      var id1 = 1,id2 = 2,id = "cur";
      var markers1 = [];
      var markers2 = [];
      var markers = [];
      function initMap() {
        map = new google.maps.Map(document.getElementById('map'), {
          center: { lat: 24.978265, lng: 121.550483 },
          zoom: 18
        });
        var image = 'https://maps.google.com/mapfiles/ms/icons/blue-dot.png'
        var image2 = 'https://maps.google.com/mapfiles/ms/icons/green-dot.png'
        var des= new google.maps.Marker({
          position:{lat:24.978265,lng:121.550483},
          map:map,
          icon:image
        })
        var destination = new google.maps.Marker({
          position: {lat: <%= lat %>,lng: <%= lng %>},
          map: map,
          icon:image2
        })
        // navigator.geolocation.getCurrentPosition(function (position) {
        //   pos = {
        //     lat: position.coords.latitude,
        //     lng: position.coords.longitude
        //   };
        //   var marker = new google.maps.Marker({
        //     position: pos,
        //     map: map
        //   })
        //   map.setCenter(pos);
        // })
      }
      function getUser1Pos(){
        x1 -= 0.0001;
        y1 -= 0.00016;

        for (var i = 0; i < markers1.length; i++) {
          markers1[i].setMap(null);
        }
        // markers1 = [];

        var marker1 = new google.maps.Marker({
          position: {lat: x1,lng: y1},
          map: map
        })
        markers1.push(marker1)
        $.post("/send", {ID:id1,lat: x1,lng:y1}, function(data, status){
          console.log("user1 success");
        })

      }
      function getUser2Pos(){
        x2 += 0.0001;
        y2 += 0.00016;
        for (var i = 0; i < markers2.length; i++) {
          markers2[i].setMap(null);
        }
        var marker2 = new google.maps.Marker({
          position: {lat: x2,lng: y2},
          map: map
        })
        markers2.push(marker2)

        $.post("/send",{ID:id2,lat: x2,lng:y2},  function(data, status){
          console.log("user2 success");
        })
      }
      function getCurPos(){
        navigator.geolocation.getCurrentPosition(function (position) {
          pos = {
            lat: position.coords.latitude,
            lng: position.coords.longitude
          };
          for (var i = 0; i < markers.length; i++) {
            markers[i].setMap(null);
          }
          var marker = new google.maps.Marker({
            position: pos,
            map: map
          })
          markers.push(marker);
          // map.setCenter(pos);
          $.post("/send",{ID:id,lat: pos.lat,lng:pos.lng},  function(data, status){
            console.log("current success");
          })
        })
      }
      setInterval(getCurPos,5000);
      setInterval(getUser1Pos,4000);
      setInterval(getUser2Pos,3000);
      // $("#show").click(function(){
      //   $.post("/senddata",{lat: pos.lat, lng: pos.lng} , function(data, status){
      //   });
      // });
    </script>

    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBtLdMhgwM1UN5bRNt7OT1y5rvUQmhpbPM&callback=initMap"></script>
  </body>
</html>